trigger:
- main

pool:
  vmImage: 'ubuntu-latest'

variables:
  acrLoginServer: 'petclinicacr091b93.azurecr.io'
  imageName: 'petclinic'
  acrConnection: 'ACR-Connection'
  aksConnection: 'AKS-Connection'

stages:
- stage: Build
  displayName: Build and Push
  jobs:
  - job: Build
    displayName: Build
    steps:
    - checkout: self

    - task: Docker@2
      displayName: Build Docker Image
      inputs:
        command: buildAndPush
        repository: $(imageName)
        dockerfile: 'Dockerfile'
        containerRegistry: $(acrConnection)
        tags: latest

- stage: Deploy
  displayName: Deploy to AKS
  dependsOn: Build
  jobs:
  - job: Deploy
    displayName: Deploy
    steps:
    - checkout: self

    # Optional: debug paths
    - script: |
        echo "System.DefaultWorkingDirectory: $(System.DefaultWorkingDirectory)"
        echo "Listing manifests dir:"
        ls -R $(System.DefaultWorkingDirectory)/manifests || echo "manifests folder not found"
      displayName: "DEBUG: Check manifests path"

    - task: KubernetesManifest@1
      displayName: Deploy to Cluster
      inputs:
        action: 'deploy'
        connectionType: 'kubernetesServiceConnection'
        kubernetesServiceConnection: $(aksConnection)
        manifests: |
          $(System.DefaultWorkingDirectory)/manifests/deployment.yaml
        containers: |
          $(acrLoginServer)/$(imageName):latest
